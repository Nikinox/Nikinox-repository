"""
Train a DQN agent to play TicTacToe against a random opponent.

Usage:
    python -m Tictactoe.train
"""
import numpy as np
from Tictactoe.Tris import TicTacToeEnv
from Tictactoe.model import DQNAgent

def train(
    episodes=3000,
    batch_size=64,
    epsilon_start=1.0,
    epsilon_end=0.05,
    epsilon_decay=3000,
    save_path="tictactoe_dqn.pth",
):
    agent = DQNAgent()
    eps = epsilon_start

    for ep in range(1, episodes + 1):
        env = TicTacToeEnv()
        state = env.reset()
        done = False
        player = 1  # agent plays as X (1)
        while not done:
            if env.current_player == player:
                s_can = env.canonical_state(player)
                legal = env.legal_actions()
                action = agent.select_action(s_can, legal, eps)
                _, reward, done, info = env.step(action)
                next_s_can = env.canonical_state(player)
                agent.store(s_can, action, reward, next_s_can, float(done))
                _ = agent.update(batch_size)
            else:
                action = int(np.random.choice(env.legal_actions()))
                _, reward, done, info = env.step(action)
                if done and info.get("winner") == -1 * player:
                    s_can = env.canonical_state(player)
                    agent.store(s_can, 0, -1.0, s_can, 1.0)

            eps = max(epsilon_end, epsilon_start - (epsilon_start - epsilon_end) * (ep / epsilon_decay))

        if ep % 100 == 0:
            print(f"Episode {ep}/{episodes}, epsilon={eps:.3f}")

    agent.save(save_path)
    print("Training complete. Model saved to", save_path)
    return agent


if __name__ == "__main__":
    train(episodes=3000)
